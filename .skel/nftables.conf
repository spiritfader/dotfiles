#!/usr/bin/nft -f
# vim:set ts=2 sw=2 et:

table inet my_table
delete table inet my_table
table inet my_table {
	chain my_input {
		type filter hook input priority filter; policy drop;
		
		# Accept traffic originated from this device
		ct state established,related accept
		
		# Accept any loopback traffic
		iif "lo" accept comment "accept loopback traffic"

		# drop invalid connections
		ct state invalid drop
		
		# accept neighbour discovery otherwise IPv6 connectivity breaks
        icmpv6 type { nd-neighbor-solicit, nd-router-advert, nd-neighbor-advert } accept comment "Accept Ipv6 NDP traffic"

		meta l4proto ipv6-icmp accept comment "accept all IPv6 ICMP (ping, etc)"
		meta l4proto icmp accept comment "accept IPv4 ICMP (ping, etc)"
		#ip protocol igmp accept accept comment "accept igmp connections"
		
		# New UDP traffic jumps to UDP chain
		meta l4proto udp ct state new jump my_udp_chain
		
		# New TCP traffic jumps to TCP chain
		tcp flags syn / fin,syn,rst,ack ct state new jump my_tcp_chain
		
		# Reject all traffic not processed by other rules
		meta l4proto udp reject comment "reject all udp traffic not processed by other rules"
		meta l4proto tcp reject with tcp reset comment "reject all tcp traffic not processed by other rules"
		
		# Log and output all dropped packets to journal
		counter log prefix "Packet Dropped: " flags all drop  
	}

	chain my_forward {
		type filter hook forward priority filter; policy drop;
		# Drop everything forwarded to us. We do not forward. That is the routers job.
	}

	chain my_output {
		type filter hook output priority filter; policy accept; 
		# Accept every outbound connection
	}

	chain my_tcp_chain {
		tcp dport 22 accept comment "accept ssh connections"
		#tcp dport 32400 accept comment "accept Plex Media Server"
		#tcp dport 32469 accept commet "accept Plex Media DLNA Server"
	}

	chain my_udp_chain {
		#udp dport 1900 accept comment "accept UPNP to discover Plex DLNA and other services"
		#udp dport 5353 ip6 daddr ff02::fb accept comment "enable multicast dns for ipv6"
		#udp dport 5353 ip daddr 224.0.0.251 accept comment "enable multicast dns for ipv4"
		#udp dport {32410,32412,32413,32414} accept comment "enable GDM network discovery for Plex Media Server"
	}
}
